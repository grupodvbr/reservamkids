<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel de Reservas ‚Ä¢ M.Kids</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --ok:#22c55e; --warn:#facc15; --danger:#f87171; --info:#3b82f6;
  --bg:#fffafc; --card:#fff; --line:#eee; --muted:#666;
  --accent:#f472b6; --brand:#60a5fa; --radius:14px;
}
body{font-family:'Poppins',sans-serif;background:var(--bg);margin:0;color:#333;}
.wrap{max-width:1080px;margin:auto;padding:24px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.title{font-weight:900;color:var(--brand);font-size:1.4rem;}
.badge{background:linear-gradient(90deg,var(--brand),var(--accent));color:#fff;padding:6px 10px;border-radius:20px;}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 4px 16px rgba(0,0,0,.06);margin-bottom:20px;}
.card-head{padding:14px 18px;border-bottom:1px dashed var(--line);display:flex;justify-content:space-between;align-items:center;}
.card-head h2{margin:0;font-size:1rem;color:var(--accent);}
.section{padding:16px;}
label{font-weight:600;font-size:.9rem;}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;}
.btn{border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;}
.btn-primary{background:var(--brand);color:#fff;}
.btn-del{background:var(--danger);color:#fff;}
.btn-status{background:var(--accent);color:#fff;}
.btn-edit{background:var(--info);color:#fff;}
.row{display:flex;gap:8px;flex-wrap:wrap;}
.hint{color:var(--muted);font-size:.85rem;}
.toast{position:fixed;bottom:18px;right:18px;background:var(--brand);color:#fff;padding:12px 14px;border-radius:12px;display:none;}
.toast.show{display:block;}
.cal{padding:16px;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.cal-day{border:1px solid var(--line);border-radius:12px;padding:10px;min-height:95px;cursor:pointer;}
.num{font-weight:700;font-size:.95rem;}
.tag{display:inline-block;font-size:.7rem;padding:2px 6px;border-radius:10px;margin-top:4px;}
.t-pend{background:#fef9c3;color:#92400e;}
.t-done{background:#dbeafe;color:#1e3a8a;}
.t-credit{background:#dcfce7;color:#166534;}
.t-canc{background:#fee2e2;color:#991b1b;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-end;z-index:50;}
.modal.show{display:flex;}
.sheet{background:#fff;width:100%;max-height:85vh;border-radius:18px 18px 0 0;overflow:auto;box-shadow:0 -10px 30px rgba(0,0,0,.25);}
.res-item{border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px;}
.res-item .name{font-weight:700;}
.res-item .name.pendente{color:var(--warn);}
.res-item .name.credito{color:var(--ok);}
.res-item .name.concluida{color:var(--info);}
.res-item .name.cancelada{color:var(--danger);}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="title">üéà Reservas ‚Ä¢ M.Kids</div>
  <div class="badge">Calend√°rio & Gerenciamento</div>
</header>

<!-- ===== FORM ===== -->
<form id="reservaForm" class="card" novalidate>
  <div class="card-head"><h2>Nova / Editar Reserva</h2></div>
  <div class="section">
    <input type="hidden" id="reservaId" name="id">
    <label>Nome</label>
    <input id="nome" name="nome" required>
    <label>Email</label>
    <input id="email" name="email" type="email" required>
    <label>Telefone</label>
    <input id="telefone" name="telefone" required>
    <label>Pessoas</label>
    <input id="pessoas" name="pessoas" type="number" min="1" required>
    <label>Local</label>
    <select id="mesa" name="mesa" required>
      <option value="">Selecione</option>
      <option>Sala de Festa</option>
      <option>Parquinho</option>
      <option>Piscina de Bolinhas</option>
    </select>
    <label>Card√°pio</label>
    <select id="cardapio" name="cardapio">
      <option value="">Selecione</option>
      <option>Buffet Kids</option>
      <option>Pizza Infantil</option>
      <option>Mini Lanches</option>
    </select>
    <label>Data e Hora</label>
    <input id="datahora" name="datahora" type="datetime-local" required>
    <label>Valor Estimado (R$)</label>
    <input id="valorEstimado" name="valorEstimado" inputmode="decimal">
    <label>Adiantamento (R$)</label>
    <input id="pagamentoAntecipado" name="pagamentoAntecipado" inputmode="decimal">
    <label>Observa√ß√µes</label>
    <textarea id="observacoes" name="observacoes" rows="3"></textarea>
  </div>
  <div class="section row" style="justify-content:flex-end;">
    <button type="reset" class="btn">Limpar</button>
    <button type="submit" class="btn btn-primary">Salvar</button>
  </div>
</form>

<!-- ===== CALEND√ÅRIO ===== -->
<div class="card">
  <div class="card-head">
    <h2>Calend√°rio de Reservas</h2>
    <div class="row">
      <button id="prevMonth" class="btn">‚óÄ</button>
      <button id="todayBtn" class="btn">Hoje</button>
      <button id="nextMonth" class="btn">‚ñ∂</button>
    </div>
  </div>
  <div class="cal">
    <div id="calTitle" style="font-weight:800;text-align:center;margin-bottom:8px"></div>
    <div id="calDow" class="cal-grid"></div>
    <div id="calGrid" class="cal-grid"></div>
  </div>
</div>

<!-- ===== MODAL ===== -->
<div class="modal" id="dayModal">
  <div class="sheet">
    <h3 id="modalTitle" style="padding:16px 16px 0 16px">Reservas do dia</h3>
    <div id="modalList" style="padding:16px"></div>
  </div>
</div>

<div id="toast" class="toast"></div>
</div>

<script>
const endpoint="https://script.google.com/macros/s/AKfycbxf8bB1gfZpal1-bN8v6hNO8gTr6fKxG2MyV_g3Rlhn-mJxF0sYuNHta_yT9zKmkd2Eww/exec";
const $=s=>document.querySelector(s);
const toast=msg=>{const t=$("#toast");t.textContent=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),3000);};
const ymd=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const dow=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
$("#calDow").innerHTML=dow.map(d=>`<div style='text-align:center;font-weight:700;color:#f472b6'>${d}</div>`).join("");
const state={mes:(new Date()).getMonth(),ano:(new Date()).getFullYear(),reservas:[]};

async function loadMonth(a,m){
  try{
    const res=await fetch(`${endpoint}?acao=listar&ano=${a}&mes=${m+1}`);
    const data=await res.json();
    state.reservas=data.map(r=>({...r,status:r.status||r.Status||"Pendente",datahora:r.datahora||r.DataHora}));
  }catch{state.reservas=[];}
  buildCalendar();
}

function buildCalendar(){
  const {mes,ano}=state;
  $("#calTitle").textContent=`${["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][mes]} de ${ano}`;
  const grid=$("#calGrid"); grid.innerHTML="";
  const first=new Date(ano,mes,1);
  const startDay=(first.getDay()+7)%7;
  const start=new Date(first); start.setDate(1-startDay);
  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const inMonth=d.getMonth()===mes;
    const cell=document.createElement("button");
    cell.className="cal-day"+(inMonth?"":" out");
    const items=state.reservas.filter(r=>r.datahora && ymd(new Date(r.datahora))===ymd(d));
    const pend=items.filter(r=>r.status==="Pendente").length;
    const cred=items.filter(r=>r.status==="Cr√©dito").length;
    const done=items.filter(r=>r.status==="Conclu√≠da").length;
    const canc=items.filter(r=>r.status==="Cancelada").length;
    cell.innerHTML=`<div class='num'>${d.getDate()}</div>
      ${pend?`<div class='tag t-pend'>Pend: ${pend}</div>`:""}
      ${cred?`<div class='tag t-credit'>Cred: ${cred}</div>`:""}
      ${done?`<div class='tag t-done'>Conc: ${done}</div>`:""}
      ${canc?`<div class='tag t-canc'>Canc: ${canc}</div>`:""}`;
    cell.onclick=()=>openDayModal(d,items);
    grid.appendChild(cell);
  }
}

function openDayModal(date,items){
  $("#modalTitle").textContent=`Reservas de ${date.toLocaleDateString("pt-BR")}`;
  const list=$("#modalList");
  if(!items.length){list.innerHTML="<div class='hint'>Nenhuma reserva neste dia.</div>";return;}
  list.innerHTML=items.map(r=>{
    const st=r.status.toLowerCase();
    const corClass=st==="cr√©dito"?"credito":st;
    const creditoTxt=(st==="cr√©dito" && r.pagamentoAntecipado)?`<div class='hint' style='color:var(--ok)'>Cr√©dito: R$ ${r.pagamentoAntecipado}</div>`:"";
    return `<div class='res-item'>
      <div class='name ${corClass}'>${r.nome||"‚Äî"}</div>
      <div class='hint'>${r.email||""} ‚Ä¢ ${r.telefone||""}</div>
      <div class='hint'>${r.mesa||""} ‚Ä¢ ${r.pessoas||0} pessoas ‚Ä¢ ${r.cardapio||""}</div>
      <div class='hint'>Data/Hora: ${new Date(r.datahora).toLocaleString("pt-BR")}</div>
      <div class='hint'>Estimado: R$ ${r.valorEstimado||"0"} ${creditoTxt}</div>
      <div class='hint'>Obs: ${r.observacoes||"‚Äî"}</div>
      <div class='row' style='margin-top:8px'>
        <button class='btn btn-edit' onclick='editarReserva("${r.id}")'>Editar</button>
        <button class='btn btn-del' onclick='excluirReserva("${r.id}")'>Excluir</button>
        <button class='btn btn-status' onclick='mudarStatus("${r.id}","${r.status}")'>Status</button>
      </div>
    </div>`;
  }).join("");
  $("#dayModal").classList.add("show");
}
$("#dayModal").onclick=e=>{if(e.target.id==="dayModal")e.target.classList.remove("show");};

// === A√á√ïES ===
async function excluirReserva(id){
  if(!confirm("Excluir esta reserva?"))return;
  await fetch(`${endpoint}?acao=excluir&id=${id}`);
  toast("üóëÔ∏è Reserva exclu√≠da!");
  loadMonth(state.ano,state.mes);
}
async function mudarStatus(id,statusAtual){
  const novo=prompt("Novo status (Pendente / Cr√©dito / Conclu√≠da / Cancelada):",statusAtual);
  if(!novo)return;
  await fetch(`${endpoint}?acao=status&id=${id}&status=${encodeURIComponent(novo)}`);
  toast("üîÑ Status atualizado!");
  loadMonth(state.ano,state.mes);
}
function editarReserva(id){
  const r=state.reservas.find(x=>x.id===id);
  if(!r)return;
  $("#reservaId").value=r.id;
  $("#nome").value=r.nome||"";
  $("#email").value=r.email||"";
  $("#telefone").value=r.telefone||"";
  $("#pessoas").value=r.pessoas||"";
  $("#mesa").value=r.mesa||"";
  $("#cardapio").value=r.cardapio||"";
  $("#datahora").value=r.datahora?new Date(r.datahora).toISOString().slice(0,16):"";
  $("#valorEstimado").value=r.valorEstimado||"";
  $("#pagamentoAntecipado").value=r.pagamentoAntecipado||"";
  $("#observacoes").value=r.observacoes||"";
  toast("‚úèÔ∏è Editando reserva de "+r.nome);
  window.scrollTo({top:0,behavior:"smooth"});
  $("#dayModal").classList.remove("show");
}

// === FORM SUBMIT ===
$("#reservaForm").onsubmit=async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const obj=Object.fromEntries(fd.entries());
  const acao=obj.id?"atualizar":"cadastrar";
  const res=await fetch(`${endpoint}?acao=${acao}`,{method:"POST",body:new URLSearchParams(obj)});
  toast(obj.id?"‚úÖ Reserva atualizada!":"‚úÖ Reserva cadastrada!");
  e.target.reset();
  $("#reservaId").value="";
  loadMonth(state.ano,state.mes);
};

// === NAVEGA√á√ÉO ===
$("#prevMonth").onclick=()=>{const d=new Date(state.ano,state.mes-1);state.mes=d.getMonth();state.ano=d.getFullYear();loadMonth(state.ano,state.mes);};
$("#nextMonth").onclick=()=>{const d=new Date(state.ano,state.mes+1);state.mes=d.getMonth();state.ano=d.getFullYear();loadMonth(state.ano,state.mes);};
$("#todayBtn").onclick=()=>{const d=new Date();state.mes=d.getMonth();state.ano=d.getFullYear();loadMonth(state.ano,state.mes);};

loadMonth(state.ano,state.mes);
</script>
</body>
</html>
