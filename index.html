<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>üéà Painel de Reservas ‚Ä¢ M.Kids</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --rosa:#f472b6;--azul:#60a5fa;--verde:#34d399;--amarelo:#facc15;
  --bg:#fff7fb;--card:#fff;--muted:#666;--line:#eee;--radius:14px;
}
*::-webkit-scrollbar{display:none;}
body{font-family:'Poppins',sans-serif;background:var(--bg);margin:0;color:#333;}
.wrap{max-width:1180px;margin:auto;padding:24px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.title{font-weight:900;color:var(--rosa);font-size:1.6rem;}
.badge{background:linear-gradient(90deg,var(--azul),var(--rosa));color:#fff;padding:6px 12px;border-radius:20px;}
.card{background:var(--card);border-radius:var(--radius);border:1px solid var(--line);box-shadow:0 4px 12px rgba(0,0,0,.06);margin-bottom:20px;}
.card-head{padding:14px 18px;border-bottom:1px dashed var(--line);display:flex;justify-content:space-between;align-items:center;}
.card-head h2{margin:0;font-size:1rem;color:var(--rosa);}
.cal{padding:16px;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.cal-day{border:1px solid var(--line);border-radius:12px;padding:8px;min-height:95px;cursor:pointer;transition:.15s;overflow:hidden;}
.cal-day:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.1);}
.num{font-weight:700;font-size:.9rem;}
.tag{display:inline-block;font-size:.7rem;padding:2px 6px;border-radius:8px;margin:1px 2px 0 0;white-space:nowrap;}
.t-norm{background:#dbeafe;color:#1e3a8a;}
.t-cred{background:#dcfce7;color:#166534;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50;}
.modal.show{display:flex;}
.sheet{background:#fff;border-radius:18px;padding:20px;max-width:720px;width:90%;max-height:90vh;overflow:auto;box-shadow:0 10px 40px rgba(0,0,0,.25);}
.res-item{border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px;position:relative;}
.edit-btn{position:absolute;top:8px;right:8px;background:none;border:0;color:var(--rosa);font-size:1.2rem;cursor:pointer;}
.btn{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;transition:.15s;}
.btn:hover{opacity:.85;}
.btn-pink{background:var(--rosa);color:#fff;}
.btn-blue{background:var(--azul);color:#fff;}
.btn-green{background:var(--verde);color:#fff;}
.btn-yellow{background:var(--amarelo);color:#fff;}
.btn-del{background:#f87171;color:#fff;}
.row{display:flex;gap:6px;flex-wrap:wrap;}
.hint{color:var(--muted);font-size:.85rem;}
.toast{position:fixed;bottom:18px;right:18px;background:var(--azul);color:#fff;padding:12px 14px;border-radius:12px;display:none;}
.toast.show{display:block;}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:20px 0;}
.kpi-card{border-radius:16px;padding:16px;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.1);}
.kpi-card h4{margin:0 0 6px;font-size:1rem;font-weight:700;}
.kpi-card .valor{font-size:1.6rem;font-weight:900;}
.kpi-antecipado{background:linear-gradient(90deg,#60a5fa,#3b82f6);}
.kpi-final{background:linear-gradient(90deg,#34d399,#10b981);}
.kpi-receber{background:linear-gradient(90deg,#fcd34d,#fbbf24);}
.kpi-total{background:linear-gradient(90deg,#f472b6,#ec4899);}
.overlay-load{position:fixed;inset:0;background:rgba(255,255,255,.9);display:none;align-items:center;justify-content:center;z-index:1000;}
.spinner{border:5px solid #eee;border-top:5px solid var(--rosa);border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);}
label{font-weight:600;font-size:.9rem;color:#444;}
.section{margin-bottom:14px;}
</style>
</head>
<body>
<div class="overlay-load" id="overlay"><div class="spinner"></div></div>

<div class="wrap">
<header>
  <div class="title">üìç Reservas ‚Ä¢ M.Kids</div>
  <div class="badge">Calend√°rio & Gerenciamento</div>
</header>

<div class="card">
  <div class="card-head">
    <h2>Calend√°rio de Reservas</h2>
    <div class="row">
      <button id="newBtn" class="btn btn-pink">+ Nova Reserva</button>
      <button id="prevMonth" class="btn btn-blue">‚óÄ</button>
      <button id="todayBtn" class="btn btn-yellow">Hoje</button>
      <button id="nextMonth" class="btn btn-blue">‚ñ∂</button>
    </div>
  </div>
  <div class="cal">
    <div id="calTitle" style="font-weight:800;text-align:center;margin-bottom:8px"></div>
    <div id="calDow" class="cal-grid"></div>
    <div id="calGrid" class="cal-grid"></div>
  </div>
</div>

<div class="summary-cards">
  <div class="kpi-card kpi-antecipado"><h4>üí∞ Antecipado</h4><div class="valor" id="kpiAntecipado">R$ 0,00</div></div>
  <div class="kpi-card kpi-final"><h4>üßæ Final Pago</h4><div class="valor" id="kpiFinalPago">R$ 0,00</div></div>
  <div class="kpi-card kpi-receber"><h4>ü™ô A Receber</h4><div class="valor" id="kpiAReceber">R$ 0,00</div></div>
  <div class="kpi-card kpi-total"><h4>üéØ Total do M√™s</h4><div class="valor" id="kpiTotalMes">R$ 0,00</div></div>
</div>

<!-- MODAL DETALHES -->
<div class="modal" id="dayModal"><div class="sheet" id="dayContent"></div></div>

<!-- MODAL FORM -->
<div class="modal" id="formModal">
  <div class="sheet">
    <h3 id="formTitle">üéà Nova Reserva</h3>
    <form id="reservaForm">
      <input type="hidden" name="id">
      <div class="section"><label>Nome Completo</label><input name="nome" required></div>
      <div class="section"><label>Email</label><input name="email" type="email"></div>
      <div class="section"><label>Telefone</label><input name="telefone" type="tel" required></div>
      <div class="section"><label>Local da Reserva</label><select name="mesa" required>
        <option>Sala de Festa</option><option>Sala VIP</option><option>Sal√£o Central</option><option>Sacada</option>
      </select></div>
      <div class="section"><label>Card√°pio</label><input name="cardapio"></div>
      <div class="section"><label>Quantidade de Pessoas</label><input name="pessoas" type="number" min="1" required></div>
      <div class="section"><label>Data e Hora</label><input name="datahora" type="datetime-local" required></div>
      <div class="section"><label>Valor Estimado (R$)</label><input name="valorEstimado" type="number" step="0.01"></div>
      <div class="section"><label>Pagamento Antecipado (R$)</label><input name="pagamentoAntecipado" type="number" step="0.01"></div>
      <div class="section"><label>Banco / M√©todo</label><select name="banco"><option value="">Selecione</option><option>Pix</option><option>Cart√£o</option><option>Dinheiro</option></select></div>
      <div class="section"><label>Observa√ß√µes</label><textarea name="observacoes"></textarea></div>
      <div class="row" style="justify-content:flex-end;">
        <button type="button" class="btn btn-del" id="cancelForm">Cancelar</button>
        <button type="submit" class="btn btn-green" id="saveBtn">Salvar</button>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast"></div>
</div>

<script>
const endpoint="https://script.google.com/macros/s/AKfycbwph1BEeCGB0GMga2_YpfSDefO5WMcjuT00-ferdF-VPheToeJWuQ9J-D-uDnins4JfDQ/exec";
const $=s=>document.querySelector(s);
const toast=msg=>{const t=$("#toast");t.textContent=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),3000);}
const overlay=show=>$("#overlay").style.display=show?"flex":"none";
const ymd=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const dow=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];$("#calDow").innerHTML=dow.map(d=>`<div style='text-align:center;font-weight:700;color:var(--rosa)'>${d}</div>`).join("");
const state={mes:(new Date()).getMonth(),ano:(new Date()).getFullYear(),reservas:[],editId:null};

async function loadMonth(a,m){overlay(true);
  try{
    const res=await fetch(`${endpoint}?acao=listar&ano=${a}&mes=${m+1}`);
    const data=await res.json();
    state.reservas=(Array.isArray(data)?data:[]).map(r=>({...r,status:(r.status||'Pendente').toLowerCase()}));
  }catch(e){state.reservas=[];}
  buildCalendar();updateSummary();overlay(false);
}

function buildCalendar(){
  const {mes,ano}=state;
  $("#calTitle").textContent=`${["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][mes]} de ${ano}`;
  const grid=$("#calGrid");grid.innerHTML="";
  const first=new Date(ano,mes,1);
  const startDay=(first.getDay()+7)%7;
  const start=new Date(first);start.setDate(1-startDay);
  for(let i=0;i<42;i++){
    const d=new Date(start);d.setDate(start.getDate()+i);
    const cell=document.createElement("div");
    cell.className="cal-day";
    const items=state.reservas.filter(r=>r.datahora&&ymd(new Date(r.datahora))===ymd(d));
    const nomes=items.slice(0,5).map(r=>{
      const nome=r.nome?.split(" ")[0]||"?";
      const classe=r.status==="cr√©dito"?"t-cred":"t-norm";
      return `<span class='tag ${classe}'>${nome}</span>`;
    }).join("");
    cell.innerHTML=`<div class='num'>${d.getDate()}</div>${nomes}`;
    cell.onclick=()=>openDayModal(d,items);
    grid.appendChild(cell);
  }
}

function updateSummary(){
  const mes=state.mes,ano=state.ano;
  const mesRes=state.reservas.filter(r=>{const d=new Date(r.datahora);return d.getMonth()===mes&&d.getFullYear()===ano;});
  let ant=0,fin=0,total=0;
  mesRes.forEach(r=>{
    const a=+r.pagamentoAntecipado||0,f=+r.valorFinalPago||0,e=+r.valorEstimado||0,s=r.status;
    ant+=a;fin+=f;if(s==="conclu√≠da"||s==="concluida")total+=f>0?f:e;else total+=e;
  });
  const rec=Math.max(total-(ant+fin),0);
  $("#kpiAntecipado").textContent=`R$ ${ant.toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
  $("#kpiFinalPago").textContent=`R$ ${fin.toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
  $("#kpiAReceber").textContent=`R$ ${rec.toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
  $("#kpiTotalMes").textContent=`R$ ${total.toLocaleString("pt-BR",{minimumFractionDigits:2})}`;
}

function openDayModal(date,items){
  const c=$("#dayContent");
  c.innerHTML=`<h3>Reservas de ${date.toLocaleDateString("pt-BR")}</h3>`;
  if(!items.length){c.innerHTML+="<p class='hint'>Nenhuma reserva.</p>";$("#dayModal").classList.add("show");return;}
  items.forEach(r=>{
    const aReceber=Math.max((+r.valorEstimado)-((+r.pagamentoAntecipado)+(+r.valorFinalPago)),0);
    let btns="";
    if(r.status!=="conclu√≠da"&&r.status!=="concluida")btns+=`<button class='btn btn-green' onclick='finalizar("${r.id}")'>Finalizar</button>`;
    if(r.status!=="cr√©dito")btns+=`<button class='btn btn-yellow' onclick='creditar("${r.id}")'>Cr√©dito</button>`;
    c.innerHTML+=`
    <div class='res-item'>
      <button class='edit-btn' onclick='editar("${r.id}")'>‚úèÔ∏è</button>
      <b>${r.nome||"Sem nome"}</b> <small>(${r.mesa||"-"})</small>
      <div class='hint'>üìû ${r.telefone||"-"} ‚Ä¢ üìß ${r.email||"-"}</div>
      <div class='hint'>üë• ${r.pessoas||"?"} pessoas ‚Ä¢ üçΩÔ∏è ${r.cardapio||"-"}</div>
      <div class='hint'>üìÖ ${new Date(r.datahora).toLocaleString("pt-BR")}</div>
      <div class='hint'>üí∞ Antecipado: R$ ${(+r.pagamentoAntecipado).toFixed(2)}</div>
      <div class='hint'>üßæ Final Pago: R$ ${(+r.valorFinalPago).toFixed(2)}</div>
      <div class='hint'>ü™ô A Receber: R$ ${aReceber.toFixed(2)}</div>
      <div class='hint'>üìù ${r.observacoes||"-"}</div>
      <div class='row' style='margin-top:8px;justify-content:flex-end'>${btns}
        <button class='btn btn-del' onclick='excluir("${r.id}")'>Excluir</button>
      </div>
    </div>`;});
  $("#dayModal").classList.add("show");
}
$("#dayModal").onclick=e=>{if(e.target.id==="dayModal")e.target.classList.remove("show");};

async function finalizar(id){const val=prompt("Valor final pago:");if(!val)return;overlay(true);
  await fetch(endpoint,{method:"POST",body:new URLSearchParams({acao:"concluir",id,valorFinalPago:val,status:"Conclu√≠da"})});
  toast("‚úÖ Finalizado!");loadMonth(state.ano,state.mes);overlay(false);}
async function creditar(id){overlay(true);
  await fetch(endpoint,{method:"POST",body:new URLSearchParams({acao:"status",id,status:"Cr√©dito"})});
  toast("üíö Marcado como cr√©dito!");loadMonth(state.ano,state.mes);overlay(false);}
async function excluir(id){if(!confirm("Excluir?"))return;overlay(true);
  await fetch(endpoint,{method:"POST",body:new URLSearchParams({acao:"excluir",id})});
  toast("üóëÔ∏è Exclu√≠do!");loadMonth(state.ano,state.mes);overlay(false);}

function editar(id){
  const r=state.reservas.find(x=>x.id===id);
  if(!r)return;
  $("#formTitle").textContent="‚úèÔ∏è Editar Reserva";
  $("#saveBtn").textContent="Atualizar";
  state.editId=id;
  for(const k in r){const el=$("#reservaForm [name='"+k+"']");if(el)el.value=r[k];}
  $("#formModal").classList.add("show");
}

$("#cancelForm").onclick=()=>$("#formModal").classList.remove("show");

$("#reservaForm").onsubmit=async e=>{
  e.preventDefault();overlay(true);
  const fd=new FormData(e.target);
  fd.append("acao",state.editId?"editar":"cadastrar");
  await fetch(endpoint,{method:"POST",body:fd});
  toast(state.editId?"‚úèÔ∏è Atualizado!":"‚úÖ Salvo!");
  $("#formModal").classList.remove("show");e.target.reset();state.editId=null;
  loadMonth(state.ano,state.mes);overlay(false);
};

$("#newBtn").onclick=()=>{state.editId=null;$("#formTitle").textContent="üéà Nova Reserva";$("#saveBtn").textContent="Salvar";$("#reservaForm").reset();$("#formModal").classList.add("show");}
$("#prevMonth").onclick=()=>{const d=new Date(state.ano,state.mes-1);state.mes=d.getMonth();state.ano=d.getFullYear();loadMonth(state.ano,state.mes);}
$("#nextMonth").onclick=()=>{const d=new Date(state.ano,state.mes+1);state.mes=d.getMonth();state.ano=d.getFullYear();loadMonth(state.ano,state.mes);}
$("#todayBtn").onclick=()=>{const d=new Date();state.mes=d.getMonth();state.ano=d.getFullYear();loadMonth(state.ano,state.mes);}
window.onload=()=>loadMonth(state.ano,state.mes);
</script>
</body>
</html>
